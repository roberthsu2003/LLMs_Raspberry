# 檢索增強生成_RAG

## 什麼是檢索增強生成_RAG

檢索增強生成（RAG）是一種人工智慧技術，它結合了檢索和生成兩種技術，以提高生成式人工智慧模型的準確性和相關性。

## 什麼是embedding模型

Embedding 模型是一種將文字轉換為向量表示的模型，可用於計算文字之間的相似度。

> [介紹向量文字空間模型](https://ai4k12.org/word-embedding-demo/)

### 目前遇到的問題

- 中文文件的 embedding 模型速度慢、效果差。

**解決方式**

- 將中文文件全部轉換為英文，使用英文的 embedding 模型（預設的模型就很好用，它使用的是 Hugging Face 的模型，速度快、效果好）。

### 如何使用embedding模型

**英文版本的embedding:**
- 嵌人模型引擎: 預設(SentenceTransformers)
- 嵌入模型: sentence-transformers/all-MiniLM-L6-v2

**繁體中文的embedding:**
- 嵌人模型引擎: 預設(SentenceTransformers)
- 嵌入模型: BAAI/bge-m3
- 目前測試效果差,不建議使用

---

## RAG的流程

```
問題
 ↓
問題向量化
 ↓
向量搜尋（Top K / Embedding）
 ↓
抓到的文件片段
 ↓
System Prompt 約束
 ↓
模型生成答案
```

## RAG準確的關鍵技巧

### 模型的參數(在工作區內設定)佔準確度30%**

### **✅ 1️⃣ 溫度（Temperature）← 已經設對 👍**

### **對 RAG 來說代表什麼？**

- 溫度越低 → 模型越「老實」
- 溫度越高 → 模型越「發揮」

### **RAG 建議值（記這個就好）**

| **用途**   | **溫度**      |
| -------- | ----------- |
| RAG 文件問答 | **0.1～0.3** |
| 教學示範     | **0.2**     |

👉 **0.3 是 OK**

如果覺得還會亂補 → 降到 0.2

### **✅ 2️⃣ top_k（生成用，不是檢索用）← 很多人搞錯**


⚠️ **這不是 RAG 的 Top K（文件搜尋）**

這個 top_k 是：

> 模型「生成下一個字」時，可以考慮的候選數量

#### **對 RAG 的影響**

- 值小 → 回答保守、穩定
- 值大 → 發揮多、易偏題

#### **RAG 建議**

```other
top_k = 1～5
```

👉 **設 3 是非常標準的 RAG 設定**

### **✅ 3️⃣ max_tokens（避免亂補後半段）**

#### **為什麼重要？**

- 文件答案通常「短」
- token 太多 → 模型開始補背景

#### **教學建議值**

```other
max_tokens = 256 ～ 512
```

這能明顯降低「答完又補一句廢話」

### **System Prompt 不夠「強硬」**


#### **常見錯誤 Prompt**

> 若文件沒有，請回答「文件中未提及」

❌ 模型有時還是會補一句

#### **改成這樣（實測很有效）**

```other
你只能根據文件內容回答問題。
若文件中沒有明確答案，
你「只能回覆以下五個字」：
文件中未提及
不得補充任何說明。
```

👉 **限定「輸出格式」會大幅降低幻覺**

---

## Embedding的設定(在設定的Documents)佔70%

### **① 文件切割方式（最常被忽略，但影響最大）**

#### **問題現象**

- 有時抓得到正確段落
- 有時抓到「前後無關」的段落

#### **原因**

> 文件切得「太長」或「語意被切斷」

#### **可以怎麼做（實務）**

**好切割的特徵**

- 一段只講一件事
- 100～300 tokens
- 不要跨章節

👉 如果用「整個 PDF / 長文章」直接丟進去

**準度一定會飄**

### **口訣**

> **一段一主題，RAG 才找得準**

---

### **② Embedding 模型 ≠ 問題語言（你這案例很關鍵）**

目前的情境是：

| **項目**    | **狀況**           |
| --------- | ---------------- |
| 文件        | 英文               |
| 問題        | 中文               |
| Embedding | all-MiniLM-L6-v2 |

#### **問題點**

> 向量比對時，其實是「中文問題 vs 英文文件」

MiniLM **能用，但不是為跨語言設計**

#### **改善方式（非常有效）**

👉 **規則一（最簡單）**

測試準度時，**問題先用英文問**

👉 **規則二（進階）**

換成 **跨語言 embedding**

#### **可驗證實驗**

- 同一題
    - 中文問 → 找不到
    - 英文問 → 找到

瞬間懂「Embedding 是關鍵」

---

### **③ Top K 設錯（不是越大越好）**

你現在是 Top K = 10，這是 **安全值**

但有時「不準」反而是因為：

> **找太多，模型亂選**

#### **建議實驗法（我強烈建議你實測）**

| **Top K** | **效果**   |
| --------- | -------- |
| 3         | 很準，但容易漏  |
| 5         | 教學最穩     |
| 10        | 容錯高，但雜訊多 |

👉 **想測準度 → 用 3 或 5**

---

## RAG測試1

### 知識庫:簡短 3 份英文產品說明書

- manual_brewbot_x1.txt
- manual_soniccloud_9.txt
- manual_floragard_pro.txt

> 測試使用比較`簡短`的內容
> [下載位置](./知識庫文件/英文文件)

### 工作區設定內容
- 工作區名稱: 3份簡單的產品說明
- 基礎模型: gpt-oss:20b-cloud
- 描述: 無線耳機,咖啡機,室內植物土壤濕度和光照監測器
- 標籤: tag3



### 系統提示詞

```text
你是一位專業、耐心且有禮貌的客服人員，同時熟悉公司所有產品的功能、規格、使用方式與常見問題。

你的任務包括：
1. 所有使用者輸入的問題,請先轉換為英文後,再去理解
2. 清楚、正確地回答問題
2. 若問題超出你能處理的範圍，請明確告知並建議聯絡人工客服或相關單位

回答原則：
- 使用繁體中文
- 語氣專業、親切、不使用情緒化字眼
- 若資訊不足，請先向使用者詢問必要資訊，不可自行假設
- 不提供不確定或未經確認的資訊
- 若沒有相關資訊,請直接說`沒有相關資訊`

人工客服的電話是:0900-888-000
```

### 測試使用者提問範例(限制模型只能依據 RAG 文件回答、避免幻覺、強化準確度評估)

RAG 測試用「使用者 Prompt ＋ 正確解答」

	
1. **測試精準數據提取**

```test
SonicCloud 9 在開啟 ANC 的情況下，電池續航時間有多長？
```

（預期回答：30 小時）

2. **測試跨文檔區分（避免混淆）**

```test
SonicCloud 9 與 FloraGard Pro 上的閃爍紅燈分別代表什麼意思？
```

（預期回答：耳機是低電量；植物監測器是水分嚴重不足。）

3. **測試故障排除流程**

```test
我的 BrewBot X1 顯示錯誤代碼 E02，我該怎麼辦？
```

（預期回答：研磨機卡住，請清潔豆槽。）

4. **測試缺失資訊（幻覺測試）**

```test
BrewBot X1 是否支援 5GHz WiFi？
```

（預期回答：不支援，僅支援 2.4GHz。）

---

## RAG測試2

### 知識庫: 1篇長的英文權益說明書

- 信用卡權益說明_en.txt

> 測試使用比較`長`的內容
> [下載位置](./知識庫文件/中文文件)

### 工作區設定內容
- 工作區名稱: 信用卡權益說明
- 基礎模型: gpt-oss:20b-cloud
- 描述: 一篇長文章的信用卡權益說明
- 標籤: tag_long


### System Prompt（系統提示詞，給模型用）

```text
你是一個信用卡權益說明文件的專業助理。
你的所有回答「只能」根據已提供的文件內容，不得使用常識推測、外部知識或自行補充。
如果文件中沒有明確資訊，請明確回答「文件中未提及」。
如果問題是有需要計算,請依據文件提供的內容計算

所有回應必須使用「繁體中文」。
回答時請保持精確、條列清楚、用詞正式，不加入個人意見。
```

### RAG 測試用「使用者 Prompt ＋ 正確解答」

以下每一題都刻意設計成可精準比對文件內容，非常適合用來測試：
	•	段落檢索是否正確
	•	數字是否算對
	•	條件是否理解正確

⸻

#### 測試題 1｜年費理解（基本準確度）

使用者 Prompt

```
Premium Cash Back Credit Card 的正卡與附卡年費是多少？什麼情況下第二年可以免年費？
```

**正確解答**
- 正卡年費：新臺幣 3,000 元
- 附卡年費：新臺幣 1,500 元
- 首年免年費
- 第二年若年度消費達新臺幣 120,000 元，可免年費

⸻

#### 測試題 2｜回饋比例（條件判斷）

使用者 Prompt

```
Premium Cash Back Credit Card 在國內與海外消費的現金回饋比例各是多少？
```

**正確解答**
- 國內消費現金回饋：1.2%
- 海外消費現金回饋：2.5%

⸻

#### 測試題 3｜點數計算（數學＋條件）

使用者 Prompt

```
使用 Bonus Points Card，在生日當月於指定超市消費新臺幣 1,000 元，可以獲得多少點數？
```

**正確解答**
- 指定商店點數累積：每新臺幣 10 元 = 1 點
- 1,000 ÷ 10 = 100 點
- 生日當月點數加倍
- 實得點數：200 點

⸻

#### 測試題 4｜現金回饋上限（陷阱題）

使用者 Prompt

```
Premium Cash Back Credit Card 的國內與海外現金回饋，每月與每年各有什麼上限？
```

**正確解答**
- 國內消費：
- 每月現金回饋上限為新臺幣 1,000 元
- 海外消費：
- 每月現金回饋上限為新臺幣 2,000 元
- 全年現金回饋上限：
- 新臺幣 30,000 元

⸻

#### 測試題 5｜海外實際回饋率（理解能力）

使用者 Prompt

```
若海外消費新臺幣 100,000 元，包含 1.5% 國外交易手續費，實際可得到多少現金回饋？實質回饋率是多少？
```

**正確解答**
- 原始回饋：
- 100,000 × 2.5% = 2,500 元
- 國外交易手續費：
- 100,000 × 1.5% = 1,500 元
- 實際淨回饋金額：
- 2,500 − 1,500 = 1,000 元
- 實質回饋率：
- 1.0%

⸻

#### 測試題 6｜分期費用計算（長答案）

使用者 Prompt

```
若以一般分期購買手機 30,000 元，選擇 12 期，總共需支付多少？每期多少？
```

**正確解答**
- 12 期分期手續費率：7.5%
- 手續費：
- 30,000 × 7.5% = 2,250 元
- 總支付金額：
- 30,000 + 2,250 = 32,250 元
- 每期金額：
- 32,250 ÷ 12 ≈ 2,687 元

⸻

#### 測試題 7｜保險啟用條件（條件型 RAG）

使用者 Prompt

```
旅遊不便險需要符合什麼刷卡條件才會生效？
```

**正確解答**
- 必須使用信用卡支付 80% 以上的機票或團費
- 符合後即可享有航班延誤、行李延誤、行李遺失及旅程取消等保障

⸻

#### 測試題 8｜機場接送權益（細節檢索）

使用者 Prompt

```
Premium Card 每年可享有幾次免費機場接送？需要提前多久預約？
```

**正確解答**
- 每年免費機場接送次數：4 次
- 必須於出發前 3 天 進行預約

⸻

#### 測試題 9｜爭議款項處理時效（流程理解）

使用者 Prompt

```
信用卡交易爭議向銀行提出後，調查時間大約多久？
```

**正確解答**
- 銀行調查期間約為 30 至 60 天
- 若涉及國際卡組織，最長可達 120 天

⸻

#### 測試題 10｜文件不存在測試（防幻覺）

使用者 Prompt

```
這張信用卡是否提供加密貨幣消費回饋？
```

**正確解答
- 文件中未提及此項權益

⸻
