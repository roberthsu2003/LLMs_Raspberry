# Cloudflare Tunnel

## ç›®éŒ„

- [ä»€éº¼æ˜¯ Cloudflare Tunnelï¼Ÿ](#ä»€éº¼æ˜¯-cloudflare-tunnel)
- [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
  - [å‰ç½®éœ€æ±‚](#å‰ç½®éœ€æ±‚)
  - [é¸æ“‡éƒ¨ç½²æ–¹å¼](#é¸æ“‡éƒ¨ç½²æ–¹å¼)
- [æ–¹å¼ä¸€ï¼šåœ¨ Raspberry Pi OS ä¸Šè¨­å®šï¼ˆæ¨è–¦åˆå­¸è€…ï¼‰](#æ–¹å¼ä¸€åœ¨-raspberry-pi-os-ä¸Šè¨­å®šæ¨è–¦åˆå­¸è€…)
  - [æ­¥é©Ÿä¸€ï¼šè¨­å®šå€‹äººç¶²åŸŸ](#æ­¥é©Ÿä¸€è¨­å®šå€‹äººç¶²åŸŸ)
  - [æ­¥é©ŸäºŒï¼šå»ºç«‹ Tunnel](#æ­¥é©ŸäºŒå»ºç«‹-tunnel)
  - [æ­¥é©Ÿä¸‰ï¼šæ•´åˆ DNS](#æ­¥é©Ÿä¸‰æ•´åˆ-dns)
  - [æ­¥é©Ÿå››ï¼šé©—è­‰èˆ‡æª¢æŸ¥](#æ­¥é©Ÿå››é©—è­‰èˆ‡æª¢æŸ¥)
- [æ–¹å¼äºŒï¼šä½¿ç”¨ Docker Run éƒ¨ç½²ï¼ˆé€²éšä½¿ç”¨è€…ï¼‰](#æ–¹å¼äºŒä½¿ç”¨-docker-éƒ¨ç½²é€²éšä½¿ç”¨è€…)
  - [ä½¿ç”¨ docker run æŒ‡ä»¤](#ä½¿ç”¨-docker-run-æŒ‡ä»¤)
- [æ–¹å¼ä¸‰:ä½¿ç”¨ Docker Compose éƒ¨ç½²(é€²éšä½¿ç”¨è€…)]
  - [ä½¿ç”¨ Docker Composeï¼ˆæ¨è–¦ï¼‰](#ä½¿ç”¨-docker-composeæ¨è–¦)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [ç›¸é—œè³‡æº](#ç›¸é—œè³‡æº)

---

## ä»€éº¼æ˜¯ Cloudflare Tunnelï¼Ÿ

Cloudflare Tunnel æ˜¯ä¸€ç¨®èƒ½å¤ å®‰å…¨åœ°å°‡æ‚¨çš„å…§éƒ¨æœå‹™é€£æ¥åˆ° Cloudflare å…¨çƒç¶²è·¯çš„å·¥å…·ï¼Œè€Œç„¡éœ€å°å¤–æš´éœ²å…¬é–‹çš„ IP ä½å€ã€‚å®ƒé€éåœ¨æ‚¨çš„ä¼ºæœå™¨ä¸Šé‹è¡Œçš„è¼•é‡ç´šä»£ç†ç¨‹å¼ `cloudflared`ï¼Œå»ºç«‹ä¸€å€‹åƒ…é™å°å¤–çš„å®‰å…¨é€£ç·šï¼Œè®“å…§å¤–éƒ¨æµé‡å¯ä»¥é›™å‘å‚³è¼¸ã€‚

### æ ¸å¿ƒè§€å¿µ

> **å»ºç«‹ä¸€å€‹ Tunnel é€šé“ï¼Œä¸¦åœ¨æ‚¨çš„è£ç½®ä¸ŠåŸ·è¡Œ `cloudflared` ç¨‹å¼ä¾†é€£æ¥å®ƒã€‚æ¥è‘—ï¼Œè¨­å®šä¸€å€‹å…¬é–‹çš„ä¸»æ©Ÿåç¨± (ä¾‹å¦‚ `app.yourdomain.com`)ï¼Œä¸¦å°‡å…¶å°æ‡‰åˆ°æ‚¨æœ¬æ©Ÿçš„æœå‹™ (ä¾‹å¦‚ `http://localhost:8080`)ã€‚**

![è¨­å®šCloudflare_Tunnel](./images/è¨­å®šCloudflare_Tunnel.png)

**Tunnel vs å‚³çµ±çš„ Port Forwarding**

> [Tunnel vs å‚³çµ±çš„port Forwardingçš„é—œå¿µåœ–](./images/tunnel_portForwarding.png)

---

## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

åœ¨é–‹å§‹è¨­å®š Cloudflare Tunnel ä¹‹å‰ï¼Œæ‚¨éœ€è¦ï¼š

1. **ä¸€å€‹å€‹äººç¶²åŸŸ**ï¼ˆå¯åœ¨ [GoDaddy](https://godaddy.com) æˆ–å…¶ä»–è¨»å†Šå•†è³¼è²·ï¼‰
2. **Cloudflare å¸³è™Ÿ**ï¼ˆå…è²»ç‰ˆå³å¯ï¼‰
3. **Raspberry Pi** æˆ–å·²å®‰è£ Docker çš„ä¼ºæœå™¨
4. **å·²é‹è¡Œçš„æœ¬æ©Ÿæœå‹™**ï¼ˆä¾‹å¦‚ Open WebUIã€n8n ç­‰ï¼‰

### é¸æ“‡éƒ¨ç½²æ–¹å¼

æ ¹æ“šæ‚¨çš„ä½¿ç”¨æƒ…å¢ƒé¸æ“‡é©åˆçš„éƒ¨ç½²æ–¹å¼ï¼š

| éƒ¨ç½²æ–¹å¼ | é©ç”¨å°è±¡ | å„ªé» |
|---------|---------|------|
| **Raspberry Pi OS** | åˆå­¸è€…ã€å–®ä¸€æœå‹™ | è¨­å®šç°¡å–®ã€æ˜“æ–¼ç†è§£ |
| **Docker (docker run)** | ç†Ÿæ‚‰ Docker çš„ä½¿ç”¨è€… | å¿«é€Ÿéƒ¨ç½²ã€æ˜“æ–¼ç®¡ç† |
| **Docker Compose** | å¤šæœå‹™ç®¡ç†ã€é€²éšä½¿ç”¨è€… | çµ±ä¸€ç®¡ç†ã€é…ç½®æ¸…æ™° |

> ğŸ’¡ **å»ºè­°**ï¼šåˆå­¸è€…å…ˆåœ¨ Raspberry Pi OS ä¸Šæ¸¬è©¦ï¼Œç†Ÿæ‚‰æµç¨‹å¾Œå†ä½¿ç”¨ Docker éƒ¨ç½²ã€‚

---

## æ–¹å¼ä¸€ï¼šåœ¨ Raspberry Pi OS ä¸Šè¨­å®šï¼ˆæ¨è–¦åˆå­¸è€…ï¼‰

### æ­¥é©Ÿä¸€ï¼šè¨­å®šå€‹äººç¶²åŸŸ

> **æ ¸å¿ƒè§€å¿µ**ï¼šä¸€æ—¦å°‡ç¶²åŸŸçš„åç¨±ä¼ºæœå™¨ (Nameserver) æŒ‡å‘ Cloudflareï¼ŒDNS çš„ç®¡ç†æ¬Šé™å³ç”± Cloudflare æ¥ç®¡ï¼Œè€ŒéåŸè¨»å†Šå•†ï¼ˆå¦‚ GoDaddyï¼‰ã€‚

![ç¶²åŸŸç®¡è½„æ¬Šçš„è½‰ç§»](./images/ç¶²åŸŸç®¡è½„æ¬Šçš„è½‰ç§».png)

#### 1. è¨»å†Šç¶²åŸŸä¸¦æ›´æ–°åç¨±ä¼ºæœå™¨

1. **è¨»å†Šç¶²åŸŸ**ï¼šæ–¼ç¶²åŸŸè¨»å†Šå•†ï¼ˆå¦‚ [GoDaddy](https://godaddy.com)ï¼‰ç”³è«‹ä¸€å€‹å€‹äººç¶²åŸŸã€‚
2. **æ–°å¢ç¶²ç«™è‡³ Cloudflare**ï¼š
   * ç™»å…¥ [Cloudflare](https://cloudflare.com)
   * å°‡æ‚¨å‰›ç”³è«‹çš„ç¶²åŸŸæ–°å¢ç‚ºä¸€å€‹ç«™é»
   * é€²å…¥è©²ç«™é»çš„ DNS è¨­å®šé é¢
   * Cloudflare æœƒæä¾›å…©çµ„å°ˆå±¬çš„åç¨±ä¼ºæœå™¨ (Nameserver) ä½å€
3. **æ›´æ–°åç¨±ä¼ºæœå™¨**ï¼š
   * å›åˆ° GoDaddy çš„ DNS ç®¡ç†é é¢
   * æ‰¾åˆ°ã€Œåç¨±ä¼ºæœå™¨ (Nameservers)ã€è¨­å®š
   * å°‡å…¶å¾ GoDaddy é è¨­å€¼æ›´æ”¹ç‚º Cloudflare æä¾›çš„é‚£å…©çµ„ä½å€

#### 2. é©—è­‰ç¶²åŸŸè¨­å®š

**åœ–å½¢åŒ–ä»‹é¢ (GUI) é©—è­‰**

1. ç™»å…¥ Cloudflareï¼Œæª¢æŸ¥æ‚¨ç¶²åŸŸå°ˆæ¡ˆçš„ç‹€æ…‹æ˜¯å¦é¡¯ç¤ºç‚º **`ä½¿ç”¨ä¸­ (Active)`**
2. å°è¦½è‡³å°ˆæ¡ˆå…§çš„ **`DNS > è¨˜éŒ„ (Records)`** é é¢ï¼Œç¢ºèªæ‚¨æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ DNS è¨˜éŒ„

**å‘½ä»¤åˆ—ä»‹é¢ (CLI) é©—è­‰**

è‹¥æ‚¨çš„ç³»çµ±ï¼ˆå¦‚ Raspberry Piï¼‰å°šæœªå®‰è£ DNS æŸ¥è©¢å·¥å…·ï¼Œè«‹åŸ·è¡Œï¼š

```bash
sudo apt update
sudo apt install dnsutils
```

æ¥è‘—ï¼ŒæŸ¥è©¢æ‚¨ç¶²åŸŸçš„ NS (Name Server) è¨˜éŒ„ï¼š

```bash
# ä½¿ç”¨ nslookup
nslookup -type=NS your-domain.com

# æˆ–ä½¿ç”¨ dig
dig NS your-domain.com
```

å¦‚æœå›å‚³çš„çµæœæ˜¯ Cloudflare æä¾›çš„é‚£å…©çµ„ä¼ºæœå™¨ä½å€ï¼Œå³ä»£è¡¨è¨­å®šæ­£ç¢ºã€‚

![DNSè§£ææµç¨‹åœ–](./images/DNSè§£ææµç¨‹åœ–.png)

---

### æ­¥é©ŸäºŒï¼šå»ºç«‹ Tunnel

#### 1. é€²å…¥ Cloudflare Zero Trust å„€è¡¨æ¿

1. åœ¨ Cloudflare å„€è¡¨æ¿ä¸­ï¼Œå°è¦½è‡³ **`Zero Trust`**
2. åœ¨å·¦å´é¸å–®ä¸­ï¼Œé¸æ“‡ **`ç¶²è·¯ (Network) > é€£æ¥å™¨`**
3. é»æ“Š **`å»ºç«‹ Tunnel (Create a Tunnel)`**

#### 2. é¸æ“‡é€šé“é¡å‹

* é€šé“é¡å‹é¸æ“‡ **Cloudflared**

  > Cloudflared æ˜¯ Cloudflare æä¾›çš„å®˜æ–¹é€£æ¥å™¨ï¼Œç”¨ä¾†åœ¨æœ¬æ©Ÿèˆ‡ Cloudflare ä¹‹é–“å»ºç«‹å®‰å…¨é€šé“ã€‚

#### 3. ç‚ºé€šé“å‘½å

* è¼¸å…¥é€šé“åç¨±ï¼Œä¾‹å¦‚ï¼š`web`ã€`app`ã€`n8n`
* æ­¤åç¨±åƒ…ç”¨æ–¼ç®¡ç†èˆ‡è­˜åˆ¥ï¼Œä¸å½±éŸ¿å¯¦éš›å°å¤–ç¶²å€

#### 4. é¸æ“‡åŸ·è¡Œç’°å¢ƒ

* ä¾å¯¦éš›ä¸»æ©Ÿä½œæ¥­ç³»çµ±é¸æ“‡ï¼Œä¾‹å¦‚ï¼š**Debian**ã€**Ubuntu**ã€**Raspberry Pi OS**

#### 5. å®‰è£ cloudflared æ‡‰ç”¨ç¨‹å¼

* ä¾ç…§ Cloudflare æä¾›çš„æŒ‡ä»¤ï¼Œåœ¨çµ‚ç«¯æ©Ÿä¸­ä¸‹è¼‰ä¸¦å®‰è£ `cloudflared`
* å®‰è£å®Œæˆå¾Œï¼Œå³å¯ä½¿ç”¨ `cloudflared` æŒ‡ä»¤

#### 6. ï¼ˆå»ºè­°ï¼‰æ¸¬è©¦èˆ‡æœå‹™å®‰è£

* å¯å…ˆæ‰‹å‹•åŸ·è¡Œ Tunnelï¼Œç¢ºèªå¯æ­£å¸¸é€£ç·š
* æ¥è‘—å¯å°‡ `cloudflared` å®‰è£æˆç³»çµ±æœå‹™ï¼ˆserviceï¼‰ï¼Œè®“é›»è…¦æˆ–ä¼ºæœå™¨é–‹æ©Ÿæ™‚è‡ªå‹•å•Ÿå‹• Tunnel

#### 7. ç¢ºèªé€£ç·šç‹€æ…‹

* å›åˆ° Dashboard ç¢ºèªé€£ç·šç‹€æ…‹
* è‹¥é€£ç·šæˆåŠŸï¼Œä¸‹æ–¹ **Connectors** å€åŸŸæœƒé¡¯ç¤ºè©²ä¸»æ©Ÿç‚º **å·²é€£ç·šï¼ˆConnectedï¼‰**

#### 8. é€²å…¥ä¸‹ä¸€æ­¥

* ç¢ºèªç„¡èª¤å¾Œï¼Œé»é¸ **ã€Œä¸‹ä¸€æ­¥ï¼ˆNextï¼‰ã€**

---

### æ­¥é©Ÿä¸‰ï¼šæ•´åˆ DNS

æ­¤æ­¥é©Ÿçš„ç›®çš„ï¼Œæ˜¯å°‡è‡ªå·±çš„ç¶²åŸŸåç¨±ï¼ˆDNSï¼‰æŒ‡å‘å‰›å»ºç«‹çš„ Tunnelã€‚

#### 1. é€²å…¥ DNS æ•´åˆè¨­å®š

* é€²å…¥ **æ•´åˆ DNSï¼ˆRoute Tunnel / Publish Applicationï¼‰** æ­¥é©Ÿ

#### 2. é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹

* é¸æ“‡ **ç‚º Web æ–°å¢å·²ç™¼ä½ˆçš„æ‡‰ç”¨ç¨‹å¼è·¯ç”±**

  > ä»£è¡¨é€é Tunnelï¼Œå°‡å¤–éƒ¨ç¶²åŸŸçš„è«‹æ±‚å®‰å…¨åœ°è½‰é€åˆ°å…§éƒ¨æœå‹™ã€‚

#### 3. è¨­å®šä¸»æ©Ÿåç¨±ï¼ˆHostnameï¼‰

* **å­ç¶²åŸŸï¼ˆSubdomainï¼‰**ï¼šä¾‹å¦‚ `www`ã€`app`ã€`n8n`
* **ç¶²åŸŸï¼ˆDomainï¼‰**ï¼šé¸æ“‡å·²åŠ å…¥ Cloudflare ä¸¦ç”±å…¶ç®¡ç† DNS çš„ç¶²åŸŸ
* çµ„åˆå¾Œçš„å°å¤–ç¶²å€ä¾‹å¦‚ï¼š`app.example.com`

#### 4. ï¼ˆé¸æ“‡æ€§ï¼‰è¨­å®šè·¯å¾‘ï¼ˆPathï¼‰

* è‹¥åªæƒ³è®“ç‰¹å®šè·¯å¾‘èµ°æ­¤ Tunnelï¼Œå¯è¨­å®šå¦‚ï¼š`/api`
* è‹¥æ•´å€‹ç¶²ç«™æˆ–æœå‹™éƒ½ä½¿ç”¨ Tunnelï¼Œå¯ç•™ç©º

#### 5. è¨­å®šæœå‹™ï¼ˆServiceï¼‰

* **é¡å‹ï¼ˆTypeï¼‰**ï¼šé€šå¸¸é¸æ“‡ `HTTP` æˆ– `HTTPS`
* **URL**ï¼šè¼¸å…¥å…§éƒ¨æœå‹™ä½å€ï¼Œä¾‹å¦‚ï¼š
  * `http://localhost:3000`
  * `http://127.0.0.1:5678`

#### 6. ï¼ˆé€²éšï¼‰å…¶ä»–æ‡‰ç”¨ç¨‹å¼è¨­å®š

* å¯ä¾éœ€æ±‚èª¿æ•´é€¾æ™‚ã€HTTP Host Headerã€TLS ç­‰é€²éšé¸é …
* æ•™å­¸æˆ–åˆå­¸æƒ…å¢ƒå¯å…ˆç¶­æŒé è¨­å€¼

#### 7. å®Œæˆè¨­å®š

* é»é¸ **ã€Œå®Œæˆè¨­å®šï¼ˆFinishï¼‰ã€**
* Cloudflare æœƒè‡ªå‹•å»ºç«‹å°æ‡‰çš„ DNS ç´€éŒ„ï¼Œä¸¦å°‡æµé‡å°å‘ Tunnel

---

### æ­¥é©Ÿå››ï¼šé©—è­‰èˆ‡æª¢æŸ¥

#### é©—è­‰è¨­å®šçµæœ

1. åœ¨ç€è¦½å™¨è¼¸å…¥è¨­å®šçš„ç¶²åŸŸåç¨±
2. è‹¥å…§éƒ¨æœå‹™ç•«é¢å¯æ­£å¸¸é¡¯ç¤ºï¼Œè¡¨ç¤ºï¼š
   * DNS è¨­å®šæˆåŠŸ
   * Tunnel é€£ç·šæˆåŠŸ
   * æœ¬æ©Ÿæœå‹™é‹ä½œæ­£å¸¸

![the_full_journey](./images/the_full_journey.png)

#### æª¢æŸ¥é€£ç·šç‹€æ…‹

ä¹‹å¾Œï¼Œæ‚¨å¯ä»¥åœ¨ Cloudflare çš„ Tunnel è¨­å®šé é¢ï¼Œé€é **é€šé“åç¨±** å€å¡Šçš„ç‹€æ…‹ä¾†åˆ¤æ–·é€£ç·šæ˜¯å¦æˆåŠŸï¼š

* æ­£å¸¸é€£ç·šæ™‚æœƒé¡¯ç¤º **`é€£ç·š`**
* è‹¥ä¸­æ–·å‰‡æœƒé¡¯ç¤º **`é—œé–‰`**

---

## æ–¹å¼äºŒï¼šä½¿ç”¨ Docker éƒ¨ç½²ï¼ˆé€²éšä½¿ç”¨è€…ï¼‰

æœ¬ç¯€èªªæ˜å¦‚ä½•åœ¨ Docker ç’°å¢ƒä¸­è¨­å®š Cloudflare Tunnelï¼Œé©ç”¨æ–¼å·²ä½¿ç”¨ Docker éƒ¨ç½²æœå‹™çš„å ´æ™¯ã€‚

### ä½¿ç”¨ docker run æŒ‡ä»¤

#### æ­¥é©Ÿä¸€ï¼šéƒ¨ç½² Open WebUI å®¹å™¨

é¦–å…ˆï¼Œå»ºç«‹ Open WebUI æœå‹™å®¹å™¨ï¼š

```docker
docker run -d \
  --network=host \
  -v open-webui:/app/backend/data \
  -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
  --name open-webui \
  --restart always \
  ghcr.io/open-webui/open-webui:main
```

#### æ­¥é©ŸäºŒï¼šéƒ¨ç½² Cloudflare Tunnel å®¹å™¨

##### âš ï¸ é‡è¦æé†’

**è«‹å‹¿ç›´æ¥ä½¿ç”¨ Cloudflare å®˜æ–¹æ–‡ä»¶å»ºè­°çš„ Docker æŒ‡ä»¤**ï¼Œå¦å‰‡æœƒå‡ºç¾é€£ç·šå•é¡Œã€‚

##### Cloudflare å®˜æ–¹å»ºè­°çš„æŒ‡ä»¤ï¼ˆæœƒå‡ºéŒ¯ï¼‰

```docker
docker run cloudflare/cloudflared:latest tunnel --no-autoupdate run --token <TOKEN>
```

##### ç‚ºä»€éº¼æœƒå‡ºéŒ¯ï¼Ÿ

æ­¤æŒ‡ä»¤ç¼ºå°‘ä»¥ä¸‹é—œéµåƒæ•¸ï¼Œæœƒå°è‡´é€£ç·šå¤±æ•—ï¼š

1. **ç¼ºå°‘ `--network=host` åƒæ•¸**
   * å®¹å™¨ç„¡æ³•æ­£å¸¸é€£ç·šåˆ°æœ¬æ©Ÿæœå‹™ï¼ˆå¦‚ `localhost:3000`ï¼‰
   * Tunnel ç„¡æ³•å°‡å¤–éƒ¨è«‹æ±‚è½‰é€åˆ°å…§éƒ¨æœå‹™

2. **ç¼ºå°‘ `-d` åƒæ•¸**
   * å®¹å™¨ä»¥å‰æ™¯æ¨¡å¼åŸ·è¡Œï¼Œçµ‚ç«¯æ©Ÿé—œé–‰å¾Œå®¹å™¨ä¹Ÿæœƒåœæ­¢
   * ç„¡æ³•åœ¨èƒŒæ™¯æŒçºŒé‹è¡Œ

##### âœ… æ­£ç¢ºçš„ Docker æŒ‡ä»¤

ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å¯ç¢ºä¿ Tunnel æ­£å¸¸é‹ä½œï¼š

```docker
docker run -d \
  --name cloudflared \
  --network=host \
  --restart unless-stopped \
  cloudflare/cloudflared:latest \
  tunnel run --token <TOKEN>
```

##### æŒ‡ä»¤åƒæ•¸èªªæ˜

* `-d`ï¼šä»¥å¾Œå°æ¨¡å¼ï¼ˆdetached modeï¼‰åŸ·è¡Œå®¹å™¨
* `--name cloudflared`ï¼šç‚ºå®¹å™¨å‘½åï¼Œæ–¹ä¾¿å¾ŒçºŒç®¡ç†èˆ‡æ“ä½œ
* `--network=host`ï¼šä½¿ç”¨ä¸»æ©Ÿç¶²è·¯æ¨¡å¼ï¼Œè®“å®¹å™¨å¯ä»¥ç›´æ¥å­˜å– `localhost` æœå‹™
* `--restart unless-stopped`ï¼šè¨­å®šå®¹å™¨è‡ªå‹•é‡å•Ÿç­–ç•¥ï¼Œé™¤éæ‰‹å‹•åœæ­¢å¦å‰‡æœƒè‡ªå‹•é‡å•Ÿ
* `<TOKEN>`ï¼šè«‹æ›¿æ›ç‚ºæ‚¨åœ¨ Cloudflare Dashboard ä¸­å–å¾—çš„ Tunnel Token

---

### ä½¿ç”¨ Docker Composeï¼ˆæ¨è–¦ï¼‰

å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨ Docker Compose ä¾†ç®¡ç†å¤šå€‹å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼çµ±ä¸€éƒ¨ç½² Open WebUI å’Œ Cloudflare Tunnelã€‚

#### ç‚ºä»€éº¼è¦ä½¿ç”¨ network_mode: hostï¼Ÿ

**åœ¨ Raspberry Pi ä¸Šçš„ç¶²è·¯æ¶æ§‹ï¼š**

| å®¹å™¨ | æ‚¨æœŸå¾…çš„ localhost |
|------|-------------------|
| open-webui | Pi çš„ localhost |
| cloudflared | Pi çš„ localhost |
| ollama | Pi çš„ localhost |

**åªè¦ä¸‰è€…éœ€è¦å…±ç”¨ `127.0.0.1`ï¼Œå°±ä¸€å®šè¦ä½¿ç”¨ `network_mode: host`**

âŒ **å¦‚æœæ”¹æˆ bridge networkï¼š**

* `127.0.0.1` æœƒè®Šæˆã€Œå®¹å™¨è‡ªå·±ã€
* cloudflared æœƒæ‰¾ä¸åˆ° open-webui
* open-webui æœƒæ‰¾ä¸åˆ° ollama

**æ¶æ§‹é—œä¿‚åœ–ï¼š**

```
[ Internet ]
     â”‚
     â–¼
Cloudflare Tunnel
     â”‚  (cloudflared container)
     â–¼
Raspberry Pi localhost
     â”‚
     â”œâ”€â”€ Open WebUI : http://127.0.0.1:3000
     â””â”€â”€ Ollama     : http://127.0.0.1:11434
```

ğŸ‘‰ **é‡è¦è§€å¿µï¼š**

* Tunnel **ä¸æ˜¯é€£ Docker å®¹å™¨**
* Tunnel **æ˜¯é€£ Pi æœ¬æ©Ÿæœå‹™**

#### å»ºç«‹ docker-compose.yml

è«‹åœ¨ä»»æ„è³‡æ–™å¤¾å»ºç«‹ä¸€å€‹æª”æ¡ˆ `docker-compose.yml`ï¼Œå…§å®¹å¦‚ä¸‹ï¼š

```yaml
version: "3.9"

services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    network_mode: host
    volumes:
      - open-webui:/app/backend/data
    environment:
      OLLAMA_BASE_URL: http://127.0.0.1:11434

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    network_mode: host
    command: tunnel run --token <TOKEN>

volumes:
  open-webui:
    external: true
```

ğŸ“Œ **é€™å€‹ compose æª”æ¡ˆçš„åŠŸèƒ½ï¼Œèˆ‡æ‚¨åŸæœ¬çš„å…©å€‹ `docker run` æŒ‡ä»¤å®Œå…¨ç­‰åƒ¹**

#### å•Ÿå‹•èˆ‡ç®¡ç†æ–¹å¼

**å•Ÿå‹•æœå‹™ï¼š**

```bash
docker compose up -d
```

**æª¢æŸ¥å®¹å™¨ç‹€æ…‹ï¼š**

```bash
docker compose ps
```

**æŸ¥çœ‹æ—¥èªŒï¼ˆéå¸¸é‡è¦ï¼Œç”¨æ–¼æ’æŸ¥å•é¡Œï¼‰ï¼š**

```bash
docker compose logs -f cloudflared
```

#### é€²éšå„ªåŒ–å»ºè­°ï¼ˆé¸ç”¨ï¼‰

ç­‰æ‚¨ç†Ÿæ‚‰åŸºæœ¬æ“ä½œå¾Œï¼Œå¯ä»¥è€ƒæ…®ä»¥ä¸‹å„ªåŒ–ï¼š

**1. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æª”æ¡ˆï¼ˆ.envï¼‰ç®¡ç† Token**

å»ºç«‹ `.env` æª”æ¡ˆï¼š

```
CLOUDFLARE_TOKEN=xxxxx
```

åœ¨ `docker-compose.yml` ä¸­ä½¿ç”¨ï¼š

```yaml
command: tunnel run --token ${CLOUDFLARE_TOKEN}
```

**2. å›ºå®šæœå‹™ç«¯å£**

å¦‚æœæœªä¾†ä¸ä½¿ç”¨ host networkï¼Œå¯ä»¥ç‚º open-webui å›ºå®šç«¯å£ã€‚

**3. æ·»åŠ ä¾è³´é—œä¿‚**

é›–ç„¶ host network æ¨¡å¼ä¸‹ä¸å¼·åˆ¶ï¼Œä½†å¯ä»¥åŠ ä¸Š `depends_on` ä¾†ç¢ºä¿å•Ÿå‹•é †åºã€‚

---

## æ•…éšœæ’æŸ¥

å¦‚æœè¨­å®šå®Œæˆå¾Œä»ç„¶ç„¡æ³•é€£ç·šï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šä»¥ä¾¿è¨ºæ–·ï¼š

* `docker compose ps` çš„è¼¸å‡ºçµæœï¼ˆå¦‚æœä½¿ç”¨ Dockerï¼‰
* `docker compose logs cloudflared` çš„æ—¥èªŒå…§å®¹ï¼ˆå¦‚æœä½¿ç”¨ Dockerï¼‰
* æ‚¨åœ¨ Cloudflare Tunnel è¨­å®šçš„ **Public Hostname â†’ Service URL**

æ ¹æ“šé€™äº›è³‡è¨Šï¼Œå¯ä»¥ç²¾æº–åˆ¤æ–·å•é¡Œå‡ºåœ¨å“ªä¸€å±¤ï¼š

* **DNS è¨­å®š**ï¼šæª¢æŸ¥ç¶²åŸŸæ˜¯å¦æ­£ç¢ºæŒ‡å‘ Cloudflare
* **Tunnel é€£ç·š**ï¼šæª¢æŸ¥ cloudflared æ˜¯å¦æ­£å¸¸é‹è¡Œ
* **Container é‹è¡Œç‹€æ…‹**ï¼šæª¢æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸å•Ÿå‹•
* **localhost æœå‹™**ï¼šæª¢æŸ¥æœ¬æ©Ÿæœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ

### å¸¸è¦‹å•é¡Œ

**Q: Tunnel é¡¯ç¤ºã€Œé—œé–‰ã€ç‹€æ…‹ï¼Ÿ**

A: æª¢æŸ¥ `cloudflared` æ˜¯å¦æ­£å¸¸é‹è¡Œï¼ŒæŸ¥çœ‹æ—¥èªŒç¢ºèªéŒ¯èª¤è¨Šæ¯ã€‚

**Q: ç„¡æ³•é€£ç·šåˆ°æœ¬æ©Ÿæœå‹™ï¼Ÿ**

A: ç¢ºèªä½¿ç”¨äº† `--network=host` æˆ– `network_mode: host`ï¼Œä¸¦æª¢æŸ¥æœ¬æ©Ÿæœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œã€‚

**Q: DNS è¨­å®šå¾Œç„¡æ³•è¨ªå•ï¼Ÿ**

A: DNS å‚³æ’­éœ€è¦æ™‚é–“ï¼Œè«‹ç­‰å¾… 5-15 åˆ†é˜å¾Œå†è©¦ï¼Œæˆ–ä½¿ç”¨ç„¡ç—•è¦–çª—æ¸¬è©¦ã€‚

---

## ç›¸é—œè³‡æº

* [Cloudflare Tunnel ç°¡å ±æª”ä¸‹è¼‰](./Cloudflare_Tunnel_Guide.pptx)
* [Cloudflare å®˜æ–¹æ–‡ä»¶](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
