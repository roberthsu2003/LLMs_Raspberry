# Cloudflare Tunnel

## ç›®éŒ„

- [å‰ç½®ä½œæ¥­ï¼šè¨­å®šå€‹äººç¶²åŸŸ](#å‰ç½®ä½œæ¥­è¨­å®šå€‹äººç¶²åŸŸ)
  - [æ­¥é©Ÿä¸€ï¼šè¨»å†Šç¶²åŸŸä¸¦æ›´æ–°åç¨±ä¼ºæœå™¨](#æ­¥é©Ÿä¸€è¨»å†Šç¶²åŸŸä¸¦æ›´æ–°åç¨±ä¼ºæœå™¨)
  - [æ­¥é©ŸäºŒï¼šé©—è­‰ç¶²åŸŸè¨­å®š](#æ­¥é©ŸäºŒé©—è­‰ç¶²åŸŸè¨­å®š)
- [è¨­å®š Cloudflare Tunnel](#è¨­å®š-cloudflare-tunnel)
- [æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Tunnel](#æ­¥é©Ÿä¸€å»ºç«‹-tunnel)
  - [1. é€²å…¥ Cloudflare Zero Trust å„€è¡¨æ¿](#1-é€²å…¥-cloudflare-zero-trust-å„€è¡¨æ¿)
  - [2. é¸æ“‡é€šé“é¡å‹](#2-é¸æ“‡é€šé“é¡å‹)
  - [3. ç‚ºé€šé“å‘½å](#3-ç‚ºé€šé“å‘½å)
  - [4. é¸æ“‡åŸ·è¡Œç’°å¢ƒ](#4-é¸æ“‡åŸ·è¡Œç’°å¢ƒå»ºè­°å…ˆåœ¨raspberry-pi-osä¸Šæ¸¬è©¦æœ€å¾Œå†è‡³dockerä¸Šæ¸¬è©¦)
  - [5. å®‰è£ cloudflared æ‡‰ç”¨ç¨‹å¼](#5-å®‰è£-cloudflared-æ‡‰ç”¨ç¨‹å¼)
  - [6. ï¼ˆå»ºè­°ï¼‰æ¸¬è©¦èˆ‡æœå‹™å®‰è£](#6-å»ºè­°æ¸¬è©¦èˆ‡æœå‹™å®‰è£)
  - [7. ç¢ºèªé€£ç·šç‹€æ…‹](#7-ç¢ºèªé€£ç·šç‹€æ…‹)
  - [8. é€²å…¥ä¸‹ä¸€æ­¥](#8-é€²å…¥ä¸‹ä¸€æ­¥)
- [æ­¥é©ŸäºŒï¼šæ•´åˆè‡ªå·±çš„ DNSï¼ˆå°‡ç¶²åŸŸæŒ‡å‘ Tunnelï¼‰](#æ­¥é©ŸäºŒæ•´åˆè‡ªå·±çš„-dnså°‡ç¶²åŸŸæŒ‡å‘-tunnel)
  - [9. é€²å…¥ DNS æ•´åˆè¨­å®š](#9-é€²å…¥-dns-æ•´åˆè¨­å®š)
  - [10. é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹](#10-é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹)
  - [11. è¨­å®šä¸»æ©Ÿåç¨±ï¼ˆHostnameï¼‰](#11-è¨­å®šä¸»æ©Ÿåç¨±hostname)
  - [12. ï¼ˆé¸æ“‡æ€§ï¼‰è¨­å®šè·¯å¾‘ï¼ˆPathï¼‰](#12-é¸æ“‡æ€§è¨­å®šè·¯å¾‘path)
  - [13. è¨­å®šæœå‹™ï¼ˆServiceï¼‰](#13-è¨­å®šæœå‹™service)
  - [14. ï¼ˆé€²éšï¼‰å…¶ä»–æ‡‰ç”¨ç¨‹å¼è¨­å®š](#14-é€²éšå…¶ä»–æ‡‰ç”¨ç¨‹å¼è¨­å®š)
  - [15. å®Œæˆè¨­å®š](#15-å®Œæˆè¨­å®š)
  - [16. é©—è­‰è¨­å®šçµæœ](#16-é©—è­‰è¨­å®šçµæœ)
- [å®Œæˆè¨­å®š](#å®Œæˆè¨­å®š)
  - [æª¢æŸ¥é€£ç·šç‹€æ…‹](#æª¢æŸ¥é€£ç·šç‹€æ…‹)
- [ä½¿ç”¨ Docker ä¾†è¨­å®š Cloudflare Tunnel](#ä½¿ç”¨-docker-ä¾†è¨­å®š-cloudflare-tunnel)
  - [æ­¥é©Ÿä¸€ï¼šéƒ¨ç½² Open WebUI å®¹å™¨](#æ­¥é©Ÿä¸€éƒ¨ç½²-open-webui-å®¹å™¨)
  - [æ­¥é©ŸäºŒï¼šéƒ¨ç½² Cloudflare Tunnel å®¹å™¨(ä½¿ç”¨docker runæŒ‡ä»¤)](#æ­¥é©ŸäºŒéƒ¨ç½²-cloudflare-tunnel-å®¹å™¨ä½¿ç”¨docker-runæŒ‡ä»¤)
    - [âš ï¸ é‡è¦æé†’](#ï¸-é‡è¦æé†’)
    - [Cloudflare å®˜æ–¹å»ºè­°çš„æŒ‡ä»¤ï¼ˆæœƒå‡ºéŒ¯ï¼‰](#cloudflare-å®˜æ–¹å»ºè­°çš„æŒ‡ä»¤æœƒå‡ºéŒ¯)
    - [ç‚ºä»€éº¼æœƒå‡ºéŒ¯ï¼Ÿ](#ç‚ºä»€éº¼æœƒå‡ºéŒ¯)
    - [âœ… æ­£ç¢ºçš„ Docker æŒ‡ä»¤](#-æ­£ç¢ºçš„-docker-æŒ‡ä»¤)
    - [æŒ‡ä»¤èªªæ˜](#æŒ‡ä»¤èªªæ˜)
  - [æ­¥é©Ÿä¸‰ï¼šä½¿ç”¨ Docker Compose éƒ¨ç½²ï¼ˆé€²éšæ–¹å¼ï¼‰](#æ­¥é©Ÿä¸‰ä½¿ç”¨-docker-compose-éƒ¨ç½²é€²éšæ–¹å¼)
    - [ä¸€ã€å°ç…§æ¦‚å¿µï¼ˆå»ºç«‹æ­£ç¢ºå¿ƒæ™ºæ¨¡å‹ï¼‰](#ä¸€å°ç…§æ¦‚å¿µå»ºç«‹æ­£ç¢ºå¿ƒæ™ºæ¨¡å‹)
    - [äºŒã€å»ºç«‹ docker-compose.yml](#äºŒå»ºç«‹-docker-composeyml)
    - [ä¸‰ã€å•Ÿå‹•èˆ‡ç®¡ç†æ–¹å¼](#ä¸‰å•Ÿå‹•èˆ‡ç®¡ç†æ–¹å¼)
    - [å››ã€ç‚ºä»€éº¼ä¸€å®šè¦ä½¿ç”¨ network_mode: hostï¼Ÿ](#å››ç‚ºä»€éº¼ä¸€å®šè¦ä½¿ç”¨-network_mode-host)
    - [äº”ã€Cloudflare Tunnel èˆ‡ Open WebUI çš„é—œä¿‚åœ–](#äº”cloudflare-tunnel-èˆ‡-open-webui-çš„é—œä¿‚åœ–)
    - [å…­ã€é€²éšå„ªåŒ–å»ºè­°ï¼ˆé¸ç”¨ï¼‰](#å…­é€²éšå„ªåŒ–å»ºè­°é¸ç”¨)
    - [ä¸ƒã€æ•…éšœæ’æŸ¥](#ä¸ƒæ•…éšœæ’æŸ¥)

---

Cloudflare Tunnel æ˜¯ä¸€ç¨®èƒ½å¤ å®‰å…¨åœ°å°‡æ‚¨çš„å…§éƒ¨æœå‹™é€£æ¥åˆ° Cloudflare å…¨çƒç¶²è·¯çš„å·¥å…·ï¼Œè€Œç„¡éœ€å°å¤–æš´éœ²å…¬é–‹çš„ IP ä½å€ã€‚å®ƒé€éåœ¨æ‚¨çš„ä¼ºæœå™¨ä¸Šé‹è¡Œçš„è¼•é‡ç´šä»£ç†ç¨‹å¼ `cloudflared`ï¼Œå»ºç«‹ä¸€å€‹åƒ…é™å°å¤–çš„å®‰å…¨é€£ç·šï¼Œè®“å…§å¤–éƒ¨æµé‡å¯ä»¥é›™å‘å‚³è¼¸ã€‚

## å‰ç½®ä½œæ¥­ï¼šè¨­å®šå€‹äººç¶²åŸŸ

> æ ¸å¿ƒè§€å¿µï¼š**ä¸€æ—¦å°‡ç¶²åŸŸçš„åç¨±ä¼ºæœå™¨ (Nameserver) æŒ‡å‘ Cloudflareï¼ŒDNS çš„ç®¡ç†æ¬Šé™å³ç”± Cloudflare æ¥ç®¡ï¼Œè€ŒéåŸè¨»å†Šå•†ï¼ˆå¦‚ GoDaddyï¼‰ã€‚**

![ç¶²åŸŸç®¡è½„æ¬Šçš„è½‰ç§»](./images/ç¶²åŸŸç®¡è½„æ¬Šçš„è½‰ç§».png)



### æ­¥é©Ÿä¸€ï¼šè¨»å†Šç¶²åŸŸä¸¦æ›´æ–°åç¨±ä¼ºæœå™¨

1.  **è¨»å†Šç¶²åŸŸ**ï¼šæ–¼ç¶²åŸŸè¨»å†Šå•†ï¼ˆå¦‚ [GoDaddy](https://godaddy.com)ï¼‰ç”³è«‹ä¸€å€‹å€‹äººç¶²åŸŸã€‚
2.  **æ–°å¢ç¶²ç«™è‡³ Cloudflare**ï¼šç™»å…¥ [Cloudflare](https://cloudflare.com)ï¼Œå°‡æ‚¨å‰›ç”³è«‹çš„ç¶²åŸŸæ–°å¢ç‚ºä¸€å€‹ç«™é»ã€‚é€²å…¥è©²ç«™é»çš„ DNS è¨­å®šé é¢ï¼ŒCloudflare æœƒæä¾›å…©çµ„å°ˆå±¬çš„åç¨±ä¼ºæœå™¨ (Nameserver) ä½å€ã€‚
3.  **æ›´æ–°åç¨±ä¼ºæœå™¨**ï¼šå›åˆ° GoDaddy çš„ DNS ç®¡ç†é é¢ï¼Œæ‰¾åˆ°ã€Œåç¨±ä¼ºæœå™¨ (Nameservers)ã€è¨­å®šï¼Œå°‡å…¶å¾ GoDaddy é è¨­å€¼æ›´æ”¹ç‚º Cloudflare æä¾›çš„é‚£å…©çµ„ä½å€ã€‚

### æ­¥é©ŸäºŒï¼šé©—è­‰ç¶²åŸŸè¨­å®š

æ‚¨å¯ä»¥é€éä»¥ä¸‹ä»»ä¸€æ–¹å¼ï¼Œç¢ºèªæ‚¨çš„ç¶²åŸŸæ˜¯å¦å·²æˆåŠŸäº¤ç”± Cloudflare ç®¡ç†ã€‚

**åœ–å½¢åŒ–ä»‹é¢ (GUI) é©—è­‰**

1.  ç™»å…¥ Cloudflareï¼Œæª¢æŸ¥æ‚¨ç¶²åŸŸå°ˆæ¡ˆçš„ç‹€æ…‹æ˜¯å¦é¡¯ç¤ºç‚º **`ä½¿ç”¨ä¸­ (Active)`**ã€‚
2.  å°è¦½è‡³å°ˆæ¡ˆå…§çš„ **`DNS > è¨˜éŒ„ (Records)`** é é¢ï¼Œç¢ºèªæ‚¨æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ DNS è¨˜éŒ„ã€‚

**å‘½ä»¤åˆ—ä»‹é¢ (CLI) é©—è­‰**

æ‚¨å¯ä»¥ä½¿ç”¨ `nslookup` æˆ– `dig` ç­‰ DNS æŸ¥è©¢å·¥å…·ã€‚è‹¥æ‚¨çš„ç³»çµ±ï¼ˆå¦‚ Raspberry Piï¼‰å°šæœªå®‰è£ï¼Œè«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š
```bash
sudo apt update
sudo apt install dnsutils
```

æ¥è‘—ï¼ŒæŸ¥è©¢æ‚¨ç¶²åŸŸçš„ NS (Name Server) è¨˜éŒ„ï¼š
```bash
# ä½¿ç”¨ nslookup
nslookup -type=NS your-domain.com

# æˆ–ä½¿ç”¨ dig
dig NS your-domain.com
```
å¦‚æœå›å‚³çš„çµæœæ˜¯ Cloudflare æä¾›çš„é‚£å…©çµ„ä¼ºæœå™¨ä½å€ï¼Œå³ä»£è¡¨è¨­å®šæ­£ç¢ºã€‚

![DNSè§£ææµç¨‹åœ–](./images/DNSè§£ææµç¨‹åœ–.png)

> **ç›¸é—œè³‡æº**ï¼š[Cloudflare Tunnel ç°¡å ±æª”ä¸‹è¼‰](./Cloudflare_Tunnel_Guide.pptx)

## è¨­å®š Cloudflare Tunnel


**Tunnel vs å‚³çµ±çš„port Forwardingçš„é—œå¿µåœ–**

> [Tunnel vs å‚³çµ±çš„port Forwardingçš„é—œå¿µåœ–](./images/tunnel_portForwarding.png)


> æ ¸å¿ƒè§€å¿µï¼š**å»ºç«‹ä¸€å€‹ Tunnel é€šé“ï¼Œä¸¦åœ¨æ‚¨çš„è£ç½®ä¸ŠåŸ·è¡Œ `cloudflared` ç¨‹å¼ä¾†é€£æ¥å®ƒã€‚æ¥è‘—ï¼Œè¨­å®šä¸€å€‹å…¬é–‹çš„ä¸»æ©Ÿåç¨± (ä¾‹å¦‚ `app.yourdomain.com`)ï¼Œä¸¦å°‡å…¶å°æ‡‰åˆ°æ‚¨æœ¬æ©Ÿçš„æœå‹™ (ä¾‹å¦‚ `http://localhost:8080`)ã€‚**

![è¨­å®šCloudflare_Tunnel](./images/è¨­å®šCloudflare_Tunnel.png)

## æ­¥é©Ÿä¸€ï¼šå»ºç«‹ Tunnel

### 1. é€²å…¥ Cloudflare Zero Trust å„€è¡¨æ¿

1. åœ¨ Cloudflare å„€è¡¨æ¿ä¸­ï¼Œå°è¦½è‡³ **`Zero Trust`**ã€‚
2. åœ¨å·¦å´é¸å–®ä¸­ï¼Œé¸æ“‡ **`ç¶²è·¯ (Network) > é€£æ¥å™¨`**ã€‚
3. é»æ“Š **`å»ºç«‹ Tunnel (Create a Tunnel)`**ã€‚

### 2. é¸æ“‡é€šé“é¡å‹

* é€šé“é¡å‹é¸æ“‡ **Cloudflared**

  > Cloudflared æ˜¯ Cloudflare æä¾›çš„å®˜æ–¹é€£æ¥å™¨ï¼Œç”¨ä¾†åœ¨æœ¬æ©Ÿèˆ‡ Cloudflare ä¹‹é–“å»ºç«‹å®‰å…¨é€šé“ã€‚

### 3. ç‚ºé€šé“å‘½å

* è¼¸å…¥é€šé“åç¨±ï¼Œä¾‹å¦‚ï¼š`web`ã€`app`ã€`n8n`
* æ­¤åç¨±åƒ…ç”¨æ–¼ç®¡ç†èˆ‡è­˜åˆ¥ï¼Œä¸å½±éŸ¿å¯¦éš›å°å¤–ç¶²å€ã€‚

### 4. é¸æ“‡åŸ·è¡Œç’°å¢ƒ(å»ºè­°å…ˆåœ¨Raspberry Pi OSä¸Šæ¸¬è©¦,æœ€å¾Œå†è‡³Dockerä¸Šæ¸¬è©¦)

* ä¾å¯¦éš›ä¸»æ©Ÿä½œæ¥­ç³»çµ±é¸æ“‡ï¼Œä¾‹å¦‚ï¼š**Debian**ã€**Ubuntu**ã€**Raspberry Pi OS**

### 5. å®‰è£ cloudflared æ‡‰ç”¨ç¨‹å¼

* ä¾ç…§ Cloudflare æä¾›çš„æŒ‡ä»¤ï¼Œåœ¨çµ‚ç«¯æ©Ÿä¸­ä¸‹è¼‰ä¸¦å®‰è£ `cloudflared`
* å®‰è£å®Œæˆå¾Œï¼Œå³å¯ä½¿ç”¨ `cloudflared` æŒ‡ä»¤

### 6. ï¼ˆå»ºè­°ï¼‰æ¸¬è©¦èˆ‡æœå‹™å®‰è£

* å¯å…ˆæ‰‹å‹•åŸ·è¡Œ Tunnelï¼Œç¢ºèªå¯æ­£å¸¸é€£ç·š
* æ¥è‘—å¯å°‡ `cloudflared` å®‰è£æˆç³»çµ±æœå‹™ï¼ˆserviceï¼‰ï¼Œè®“é›»è…¦æˆ–ä¼ºæœå™¨é–‹æ©Ÿæ™‚è‡ªå‹•å•Ÿå‹• Tunnel

### 7. ç¢ºèªé€£ç·šç‹€æ…‹

* å›åˆ° Dashboard ç¢ºèªé€£ç·šç‹€æ…‹
* è‹¥é€£ç·šæˆåŠŸï¼Œä¸‹æ–¹ **Connectors** å€åŸŸæœƒé¡¯ç¤ºè©²ä¸»æ©Ÿç‚º **å·²é€£ç·šï¼ˆConnectedï¼‰**

### 8. é€²å…¥ä¸‹ä¸€æ­¥

* ç¢ºèªç„¡èª¤å¾Œï¼Œé»é¸ **ã€Œä¸‹ä¸€æ­¥ï¼ˆNextï¼‰ã€**

---

## æ­¥é©ŸäºŒï¼šæ•´åˆè‡ªå·±çš„ DNSï¼ˆå°‡ç¶²åŸŸæŒ‡å‘ Tunnelï¼‰

### 9. é€²å…¥ DNS æ•´åˆè¨­å®š

* é€²å…¥ **æ•´åˆ DNSï¼ˆRoute Tunnel / Publish Applicationï¼‰** æ­¥é©Ÿ
* æ­¤æ­¥é©Ÿçš„ç›®çš„ï¼Œæ˜¯å°‡è‡ªå·±çš„ç¶²åŸŸåç¨±ï¼ˆDNSï¼‰æŒ‡å‘å‰›å»ºç«‹çš„ Tunnelã€‚

### 10. é¸æ“‡æ‡‰ç”¨ç¨‹å¼é¡å‹

* é¸æ“‡ **ç‚º Web æ–°å¢å·²ç™¼ä½ˆçš„æ‡‰ç”¨ç¨‹å¼è·¯ç”±**

  > ä»£è¡¨é€é Tunnelï¼Œå°‡å¤–éƒ¨ç¶²åŸŸçš„è«‹æ±‚å®‰å…¨åœ°è½‰é€åˆ°å…§éƒ¨æœå‹™ã€‚

### 11. è¨­å®šä¸»æ©Ÿåç¨±ï¼ˆHostnameï¼‰

* **å­ç¶²åŸŸï¼ˆSubdomainï¼‰**ï¼š
  * ä¾‹å¦‚ï¼š`www`ã€`app`ã€`n8n`
* **ç¶²åŸŸï¼ˆDomainï¼‰**ï¼š
  * é¸æ“‡å·²åŠ å…¥ Cloudflare ä¸¦ç”±å…¶ç®¡ç† DNS çš„ç¶²åŸŸ
* çµ„åˆå¾Œçš„å°å¤–ç¶²å€ä¾‹å¦‚ï¼š

  ```
  app.example.com
  ```

### 12. ï¼ˆé¸æ“‡æ€§ï¼‰è¨­å®šè·¯å¾‘ï¼ˆPathï¼‰

* è‹¥åªæƒ³è®“ç‰¹å®šè·¯å¾‘èµ°æ­¤ Tunnelï¼Œå¯è¨­å®šå¦‚ï¼š

  ```
  /api
  ```

* è‹¥æ•´å€‹ç¶²ç«™æˆ–æœå‹™éƒ½ä½¿ç”¨ Tunnelï¼Œå¯ç•™ç©ºã€‚

### 13. è¨­å®šæœå‹™ï¼ˆServiceï¼‰

* **é¡å‹ï¼ˆTypeï¼‰**ï¼š
  * é€šå¸¸é¸æ“‡ `HTTP` æˆ– `HTTPS`
* **URL**ï¼š
  * è¼¸å…¥å…§éƒ¨æœå‹™ä½å€ï¼Œä¾‹å¦‚ï¼š

    ```
    http://localhost:3000
    ```

    æˆ–

    ```
    http://127.0.0.1:5678
    ```

### 14. ï¼ˆé€²éšï¼‰å…¶ä»–æ‡‰ç”¨ç¨‹å¼è¨­å®š

* å¯ä¾éœ€æ±‚èª¿æ•´é€¾æ™‚ã€HTTP Host Headerã€TLS ç­‰é€²éšé¸é …
* æ•™å­¸æˆ–åˆå­¸æƒ…å¢ƒå¯å…ˆç¶­æŒé è¨­å€¼ã€‚

### 15. å®Œæˆè¨­å®š

* é»é¸ **ã€Œå®Œæˆè¨­å®šï¼ˆFinishï¼‰ã€**
* Cloudflare æœƒè‡ªå‹•å»ºç«‹å°æ‡‰çš„ DNS ç´€éŒ„ï¼Œä¸¦å°‡æµé‡å°å‘ Tunnelã€‚

### 16. é©—è­‰è¨­å®šçµæœ

* åœ¨ç€è¦½å™¨è¼¸å…¥è¨­å®šçš„ç¶²åŸŸåç¨±
* è‹¥å…§éƒ¨æœå‹™ç•«é¢å¯æ­£å¸¸é¡¯ç¤ºï¼Œè¡¨ç¤ºï¼š
  * DNS è¨­å®šæˆåŠŸ
  * Tunnel é€£ç·šæˆåŠŸ
  * æœ¬æ©Ÿæœå‹™é‹ä½œæ­£å¸¸

---

## å®Œæˆè¨­å®š

![the_full_journey](./images/the_full_journey.png)

### æª¢æŸ¥é€£ç·šç‹€æ…‹

ä¹‹å¾Œï¼Œæ‚¨å¯ä»¥åœ¨ Cloudflare çš„ Tunnel è¨­å®šé é¢ï¼Œé€é **é€šé“åç¨±** å€å¡Šçš„ç‹€æ…‹ä¾†åˆ¤æ–·é€£ç·šæ˜¯å¦æˆåŠŸï¼š

* æ­£å¸¸é€£ç·šæ™‚æœƒé¡¯ç¤º **`é€£ç·š`**
* è‹¥ä¸­æ–·å‰‡æœƒé¡¯ç¤º **`é—œé–‰`**

---

## ä½¿ç”¨ Docker ä¾†è¨­å®š Cloudflare Tunnel

æœ¬ç¯€èªªæ˜å¦‚ä½•åœ¨ Docker ç’°å¢ƒä¸­è¨­å®š Cloudflare Tunnelï¼Œé©ç”¨æ–¼å·²ä½¿ç”¨ Docker éƒ¨ç½²æœå‹™çš„å ´æ™¯ã€‚

### æ­¥é©Ÿä¸€ï¼šéƒ¨ç½² Open WebUI å®¹å™¨

é¦–å…ˆï¼Œå»ºç«‹ Open WebUI æœå‹™å®¹å™¨ï¼š

```docker
docker run -d \
  --network=host \
  -v open-webui:/app/backend/data \
  -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
  --name open-webui \
  --restart always \
  ghcr.io/open-webui/open-webui:main
```

### æ­¥é©ŸäºŒï¼šéƒ¨ç½² Cloudflare Tunnel å®¹å™¨(ä½¿ç”¨docker runæŒ‡ä»¤)

#### âš ï¸ é‡è¦æé†’

**è«‹å‹¿ç›´æ¥ä½¿ç”¨ Cloudflare å®˜æ–¹æ–‡ä»¶å»ºè­°çš„ Docker æŒ‡ä»¤**ï¼Œå¦å‰‡æœƒå‡ºç¾é€£ç·šå•é¡Œã€‚

#### Cloudflare å®˜æ–¹å»ºè­°çš„æŒ‡ä»¤ï¼ˆæœƒå‡ºéŒ¯ï¼‰

```docker
docker run cloudflare/cloudflared:latest tunnel --no-autoupdate run --token <TOKEN>
```

#### ç‚ºä»€éº¼æœƒå‡ºéŒ¯ï¼Ÿ

æ­¤æŒ‡ä»¤ç¼ºå°‘ä»¥ä¸‹é—œéµåƒæ•¸ï¼Œæœƒå°è‡´å•é¡Œï¼š

1. **ç¼ºå°‘ `--network=host` åƒæ•¸**
   * å°è‡´å®¹å™¨ç„¡æ³•æ­£å¸¸é€£ç·šåˆ°æœ¬æ©Ÿæœå‹™ï¼ˆå¦‚ `localhost:3000`ï¼‰
   * Tunnel ç„¡æ³•å°‡å¤–éƒ¨è«‹æ±‚è½‰é€åˆ°å…§éƒ¨æœå‹™

2. **ç¼ºå°‘ `-d` åƒæ•¸**
   * å®¹å™¨ä»¥å‰æ™¯æ¨¡å¼åŸ·è¡Œï¼Œçµ‚ç«¯æ©Ÿé—œé–‰å¾Œå®¹å™¨ä¹Ÿæœƒåœæ­¢
   * ç„¡æ³•åœ¨èƒŒæ™¯æŒçºŒé‹è¡Œ

#### âœ… æ­£ç¢ºçš„ Docker æŒ‡ä»¤

ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤å¯ç¢ºä¿ Tunnel æ­£å¸¸é‹ä½œï¼š

```docker
docker run -d \
  --name cloudflared \
  --network=host \
  --restart unless-stopped \
  cloudflare/cloudflared:latest \
  tunnel run --token <TOKEN>
```

#### æŒ‡ä»¤èªªæ˜

* `-d`ï¼šä»¥å¾Œå°æ¨¡å¼åŸ·è¡Œå®¹å™¨
* `--name cloudflared`ï¼šç‚ºå®¹å™¨å‘½åï¼Œæ–¹ä¾¿ç®¡ç†
* `--network=host`ï¼šä½¿ç”¨ä¸»æ©Ÿç¶²è·¯æ¨¡å¼ï¼Œè®“å®¹å™¨å¯ä»¥ç›´æ¥å­˜å– `localhost` æœå‹™
* `--restart unless-stopped`ï¼šè¨­å®šå®¹å™¨è‡ªå‹•é‡å•Ÿç­–ç•¥
* `<TOKEN>`ï¼šæ›¿æ›ç‚ºæ‚¨åœ¨ Cloudflare Dashboard ä¸­å–å¾—çš„ Tunnel Token

### æ­¥é©Ÿä¸‰ï¼šä½¿ç”¨ Docker Compose éƒ¨ç½²ï¼ˆé€²éšæ–¹å¼ï¼‰

å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨ Docker Compose ä¾†ç®¡ç†å¤šå€‹å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼çµ±ä¸€éƒ¨ç½² Open WebUI å’Œ Cloudflare Tunnelã€‚

#### ä¸€ã€å°ç…§æ¦‚å¿µï¼ˆå»ºç«‹æ­£ç¢ºå¿ƒæ™ºæ¨¡å‹ï¼‰

æ‚¨ç›®å‰çš„éƒ¨ç½²ç‹€æ³ï¼š

* **open-webui**
  * ä½¿ç”¨ `--network=host`
  * ç›´æ¥é€£ç·šåˆ° Raspberry Pi çš„ `127.0.0.1:11434`ï¼ˆOllamaï¼‰
* **cloudflared**
  * ä¹Ÿä½¿ç”¨ `--network=host`
  * Tunnel æŒ‡å‘ Raspberry Pi æœ¬æ©Ÿæœå‹™ï¼ˆä¾‹å¦‚ open-webui çš„ portï¼‰

ğŸ‘‰ **æ‰€ä»¥åœ¨ docker-compose.yml è£¡ï¼š**

* å…©å€‹ service **éƒ½å¿…é ˆä½¿ç”¨** `network_mode: host`
* **ä¸èƒ½ä½¿ç”¨** `ports` æ˜ å°„
* **ä¸èƒ½ä½¿ç”¨** è‡ªè¨‚ docker network

---

#### äºŒã€å»ºç«‹ docker-compose.yml

è«‹åœ¨ä»»æ„è³‡æ–™å¤¾å»ºç«‹ä¸€å€‹æª”æ¡ˆï¼š

```
docker-compose.yml
```

å…§å®¹å¦‚ä¸‹ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰ï¼š

```yaml
version: "3.9"

services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    network_mode: host
    volumes:
      - open-webui:/app/backend/data
    environment:
      OLLAMA_BASE_URL: http://127.0.0.1:11434

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    network_mode: host
    command: tunnel run --token <TOKEN>

volumes:
  open-webui:
```

ğŸ“Œ **é€™å€‹ compose æª”æ¡ˆçš„åŠŸèƒ½ï¼Œèˆ‡æ‚¨åŸæœ¬çš„å…©å€‹ `docker run` æŒ‡ä»¤å®Œå…¨ç­‰åƒ¹**

---

#### ä¸‰ã€å•Ÿå‹•èˆ‡ç®¡ç†æ–¹å¼

**å•Ÿå‹•æœå‹™ï¼š**

```bash
docker compose up -d
```

**æª¢æŸ¥å®¹å™¨ç‹€æ…‹ï¼š**

```bash
docker compose ps
```

**æŸ¥çœ‹æ—¥èªŒï¼ˆéå¸¸é‡è¦ï¼Œç”¨æ–¼æ’æŸ¥å•é¡Œï¼‰ï¼š**

```bash
docker compose logs -f cloudflared
```

---

#### å››ã€ç‚ºä»€éº¼ä¸€å®šè¦ä½¿ç”¨ network_mode: hostï¼Ÿ

åœ¨ Raspberry Pi ä¸Šçš„ç¶²è·¯æ¶æ§‹ï¼š

| å®¹å™¨ | æ‚¨æœŸå¾…çš„ localhost |
|------|-------------------|
| open-webui | Pi çš„ localhost |
| cloudflared | Pi çš„ localhost |
| ollama | Pi çš„ localhost |

**åªè¦ä¸‰è€…éœ€è¦å…±ç”¨ `127.0.0.1`ï¼Œå°±ä¸€å®šè¦ä½¿ç”¨ `network_mode: host`**

âŒ **å¦‚æœæ”¹æˆ bridge networkï¼š**

* `127.0.0.1` æœƒè®Šæˆã€Œå®¹å™¨è‡ªå·±ã€
* cloudflared æœƒæ‰¾ä¸åˆ° open-webui
* open-webui æœƒæ‰¾ä¸åˆ° ollama

---

#### äº”ã€Cloudflare Tunnel èˆ‡ Open WebUI çš„é—œä¿‚åœ–

```
[ Internet ]
     â”‚
     â–¼
Cloudflare Tunnel
     â”‚  (cloudflared container)
     â–¼
Raspberry Pi localhost
     â”‚
     â”œâ”€â”€ Open WebUI : http://127.0.0.1:3000
     â””â”€â”€ Ollama     : http://127.0.0.1:11434
```

ğŸ‘‰ **é‡è¦è§€å¿µï¼š**

* Tunnel **ä¸æ˜¯é€£ Docker å®¹å™¨**
* Tunnel **æ˜¯é€£ Pi æœ¬æ©Ÿæœå‹™**

---

#### å…­ã€é€²éšå„ªåŒ–å»ºè­°ï¼ˆé¸ç”¨ï¼‰

ç­‰æ‚¨ç†Ÿæ‚‰åŸºæœ¬æ“ä½œå¾Œï¼Œå¯ä»¥è€ƒæ…®ä»¥ä¸‹å„ªåŒ–ï¼š

**1. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æª”æ¡ˆï¼ˆ.envï¼‰ç®¡ç† Token**

å»ºç«‹ `.env` æª”æ¡ˆï¼š

```
CLOUDFLARE_TOKEN=xxxxx
```

åœ¨ `docker-compose.yml` ä¸­ä½¿ç”¨ï¼š

```yaml
command: tunnel run --token ${CLOUDFLARE_TOKEN}
```

**2. å›ºå®šæœå‹™ç«¯å£**

å¦‚æœæœªä¾†ä¸ä½¿ç”¨ host networkï¼Œå¯ä»¥ç‚º open-webui å›ºå®šç«¯å£ã€‚

**3. æ·»åŠ ä¾è³´é—œä¿‚**

é›–ç„¶ host network æ¨¡å¼ä¸‹ä¸å¼·åˆ¶ï¼Œä½†å¯ä»¥åŠ ä¸Š `depends_on` ä¾†ç¢ºä¿å•Ÿå‹•é †åºã€‚

---

#### ä¸ƒã€æ•…éšœæ’æŸ¥

å¦‚æœè¨­å®šå®Œæˆå¾Œä»ç„¶ç„¡æ³•é€£ç·šï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šä»¥ä¾¿è¨ºæ–·ï¼š

* `docker compose ps` çš„è¼¸å‡ºçµæœ
* `docker compose logs cloudflared` çš„æ—¥èªŒå…§å®¹
* æ‚¨åœ¨ Cloudflare Tunnel è¨­å®šçš„ **Public Hostname â†’ Service URL**

æ ¹æ“šé€™äº›è³‡è¨Šï¼Œå¯ä»¥ç²¾æº–åˆ¤æ–·å•é¡Œå‡ºåœ¨å“ªä¸€å±¤ï¼š
* DNS è¨­å®š
* Tunnel é€£ç·š
* Container é‹è¡Œç‹€æ…‹
* localhost æœå‹™